<!DOCTYPE html>
<html lang="zh">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>Redis分布式消息队列</title>
                        <link rel="stylesheet" href="/theme/css/main.css" />
    <meta name="description" content="一、消息队列基础概述 1.1 定义 消息队列（Message Queue） 是一种应用程序间的异步通信机制， 核心采用 生产者-消费者模型(Producer-Consumer Model) 生产 …" />
        </head>

        <body id="index" class="home">
                <header id="banner" class="body">
                        <h1><a href="/">My Tech Blog</a></h1>
                        <nav><ul>
                                                <li class="active"><a href="/category/ru-men.html">入门</a></li>
                        </ul></nav>
                </header><!-- /#banner -->
  <section id="content" class="body">
    <article>
      <header>
        <h1 class="entry-title">
          <a href="/redisfen-bu-shi-xiao-xi-dui-lie.html" rel="bookmark"
             title="Permalink to Redis分布式消息队列">Redis分布式消息队列</a></h1>
      </header>

      <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-11-28T16:00:00+08:00">
                Published: Fri 28 November 2025
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="/author/samuelchen.html">samuel.chen</a>
                </address>
        <p>In <a href="/category/ru-men.html">入门</a>.</p>
<p>tags: <a href="/tag/redis.html">Redis</a> <a href="/tag/python.html">Python</a> </p>        
</footer><!-- /.post-info -->        <h4>一、消息队列基础概述</h4>
<h5>1.1 定义</h5>
<p><strong>消息队列（Message Queue）</strong> 是一种应用程序间的异步通信机制，</p>
<p>核心采用 生产者-消费者模型(Producer-Consumer Model)</p>
<p>生产者（Producer）将任务消息发布到队列中；</p>
<p>一个或多个消费者（Consumer/Worker）从队列中获取并处理这些任务。</p>
<h5>1.2 核心架构</h5>
<table>
<thead>
<tr>
<th>组件名称</th>
<th>核心作用</th>
<th>常用实现方案</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Producer（生产者）</strong></td>
<td>创建任务消息，并将其推入 Redis 队列。</td>
<td>业务应用中的某个函数或服务。</td>
</tr>
<tr>
<td><strong>Redis（消息中间件）</strong></td>
<td>存储任务消息队列。</td>
<td>Redis 服务器。</td>
</tr>
<tr>
<td><strong>Consumer（消费者/Worker）</strong></td>
<td>从 Redis 队列中获取任务，并执行具体逻辑。</td>
<td>一个或多个独立的后台脚本/进程。</td>
</tr>
</tbody>
</table>
<h4>二、核心Redis命令</h4>
<p>Redis 提供了多种数据结构来实现消息队列，最常用的是 <strong>List（列表）</strong>。</p>
<h5>2.1 使用 List 实现简单队列</h5>
<p>List 是一个双向链表，非常适合模拟队列的“先进先出”（FIFO）特性。</p>
<p>双向链表保存了头尾节点，所以在列表头尾两边插取元素都是非常快。</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>LPUSH</code></td>
<td><code>LPUSH queue_name value</code>，将一个或多个值插入到列表头部。</td>
<td>生产者用此命令发布任务。</td>
</tr>
<tr>
<td><code>RPOP</code></td>
<td><code>RPOP queue_name</code>，移除并获取列表的最后一个元素。</td>
<td>消费者用此命令获取任务，但如果队列为空，会立即返回<code>nil</code>，造成 CPU 空转。</td>
</tr>
<tr>
<td><strong><code>BRPOP</code></strong></td>
<td><code>BRPOP queue_name timeout</code>，<code>RPOP</code> 的阻塞版本。</td>
<td><strong>推荐使用</strong>。如果队列为空，它会阻塞连接，直到有新元素或超时。这极大地降低了 CPU 消耗，是实现高效消费者的关键。</td>
</tr>
</tbody>
</table>
<p><strong>什么是CPU空转？</strong></p>
<blockquote>
<p>CPU 空转指的是 CPU 在没有有效任务可处理时，仍被频繁调用执行无用操作，导致计算资源被浪费的状态。</p>
<p><strong>关键原因:</strong></p>
<ol>
<li>消费者会循环执行 RPOP 命令，队列为空时返回 nil，但循环不会停止。</li>
<li>每次循环都会触发 “调用命令→接收 nil→再次调用” 的无效流程，CPU 需持续处理这些空操作。</li>
<li>这些操作不产生任何业务价值，却占用 CPU 算力，导致 CPU 使用率虚高。</li>
</ol>
</blockquote>
<p><img alt="image.png" src="images/Producer-Consumer.png"></p>
<h4>三、代码实现</h4>
<p>下面我们通过 Python 代码演示如何构建一个完整的生产者-消费者系统。</p>
<h5>3.1 环境安装</h5>
<div class="highlight"><pre><span></span><code><span class="c1"># 安装 Redis 的 Python 客户端</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">redis</span>
</code></pre></div>

<h5>3.2 项目目录结构</h5>
<div class="highlight"><pre><span></span><code><span class="n">redis_queue_demo</span>
<span class="err">├──</span> <span class="n">producer</span><span class="p">.</span><span class="n">py</span>      <span class="c"># 生产者，负责发送任务</span>
<span class="err">└──</span> <span class="n">worker</span><span class="p">.</span><span class="n">py</span>        <span class="c"># 消费者/Worker，负责处理任务</span>
</code></pre></div>

<h5>3.3 生产者代码（producer.py）</h5>
<p>生产者将一个包含任务信息的字典序列化为 JSON 字符串，然后使用 <code>LPUSH</code> 推入 Redis 队列。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># 连接到 Redis</span>
<span class="n">redis_client</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">send_email_task</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a task to send an email by pushing it to a Redis list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">task_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;send_email&#39;</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
        <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="n">subject</span><span class="p">,</span>
        <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="n">task_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">task_data</span><span class="p">)</span>

    <span class="c1"># Use LPUSH to add the task to the left end of the &#39;task_queue&#39; list</span>
    <span class="n">redis_client</span><span class="o">.</span><span class="n">lpush</span><span class="p">(</span><span class="s1">&#39;task_queue&#39;</span><span class="p">,</span> <span class="n">task_json</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Task added to queue: send email to </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Send 5 email tasks as an example</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">send_email_task</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;user</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">@example.com&#39;</span><span class="p">,</span>
            <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;Test Email&#39;</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Hi user </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">! This is a test email from the Redis message queue.&#39;</span>
        <span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<h5>3.4 消费者代码（worker.py）</h5>
<p>消费者使用 <code>BRPOP</code> 阻塞式地等待任务，获取到任务后反序列化并执行。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># 连接到 Redis</span>
<span class="n">redis_client</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">process_tasks</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    无限循环，持续从队列中获取并处理任务</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Worker 已启动，等待任务...&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># BRPOP 阻塞式地从 &#39;task_queue&#39; 队列尾部获取任务</span>
            <span class="c1"># timeout=0 表示永久阻塞，直到有任务为止</span>
            <span class="c1"># 返回的是一个元组 (queue_name, task_json)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">task_json</span> <span class="o">=</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">brpop</span><span class="p">(</span><span class="s1">&#39;task_queue&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># 反序列化任务数据</span>
            <span class="n">task_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">task_json</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Received task: </span><span class="si">{</span><span class="n">task_data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (From </span><span class="si">{</span><span class="n">task_data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="c1"># --- 模拟耗时的任务处理 ---</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sending email...&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 模拟 I/O 操作</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Email sent successfully: Subject &#39;</span><span class="si">{</span><span class="n">task_data</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="c1"># --- 任务处理结束 ---</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing task: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">process_tasks</span><span class="p">()</span>
</code></pre></div>

<h5>3.5 运行与演示</h5>
<ol>
<li><strong>启动消费者</strong>：</li>
</ol>
<p>在一个终端中运行 <code>worker.py</code>。</p>
<p><strong>python</strong> <strong>worker.py</strong></p>
<p>你会看到 "Worker started, waiting for tasks..." 的提示。</p>
<div class="highlight"><pre><span></span><code><span class="n">Worker</span> <span class="n">started</span><span class="p">,</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">tasks</span><span class="p">...</span>
</code></pre></div>

<ol>
<li><strong>启动生产者</strong>：</li>
</ol>
<p>在另一个终端中运行 <code>producer.py</code>。</p>
<p><strong>python</strong> <strong>producer.py</strong></p>
<p>你会看到 producer 输出了 5 条 "Task added to queue" 的日志。</p>
<div class="highlight"><pre><span></span><code><span class="n">Task</span> <span class="n">added</span> <span class="n">to</span> <span class="n">queue</span><span class="p">:</span> <span class="n">send</span> <span class="n">email</span> <span class="n">to</span> <span class="n">user0</span><span class="nv">@example</span><span class="p">.</span><span class="n">com</span>
<span class="n">Task</span> <span class="n">added</span> <span class="n">to</span> <span class="n">queue</span><span class="p">:</span> <span class="n">send</span> <span class="n">email</span> <span class="n">to</span> <span class="n">user1</span><span class="nv">@example</span><span class="p">.</span><span class="n">com</span>
<span class="n">Task</span> <span class="n">added</span> <span class="n">to</span> <span class="n">queue</span><span class="p">:</span> <span class="n">send</span> <span class="n">email</span> <span class="n">to</span> <span class="n">user2</span><span class="nv">@example</span><span class="p">.</span><span class="n">com</span>
<span class="n">Task</span> <span class="n">added</span> <span class="n">to</span> <span class="n">queue</span><span class="p">:</span> <span class="n">send</span> <span class="n">email</span> <span class="n">to</span> <span class="n">user3</span><span class="nv">@example</span><span class="p">.</span><span class="n">com</span>
<span class="n">Task</span> <span class="n">added</span> <span class="n">to</span> <span class="n">queue</span><span class="p">:</span> <span class="n">send</span> <span class="n">email</span> <span class="n">to</span> <span class="n">user4</span><span class="nv">@example</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>

<p>任务会储存到 Redis 的 "task_queue" 列表中：</p>
<p><img alt="image.png" src="images/task_queue.png"></p>
<ol>
<li><strong>观察消费者</strong>：</li>
</ol>
<p>回到第一个终端，你会看到 Worker 正在逐个接收并处理这 5 个任务，每个任务处理耗时 2 秒。</p>
<div class="highlight"><pre><span></span><code><span class="n">Received</span> <span class="n">task</span><span class="p">:</span> <span class="n">send_email</span> <span class="p">(</span><span class="n">From</span> <span class="n">user0</span><span class="nv">@example</span><span class="p">.</span><span class="n">com</span><span class="p">)</span>
<span class="n">Sending</span> <span class="n">email</span><span class="p">...</span>
<span class="n">Email</span> <span class="n">sent</span> <span class="n">successfully</span><span class="p">:</span> <span class="n">Subject</span> <span class="s1">&#39;Test Email&#39;</span>

<span class="n">Received</span> <span class="n">task</span><span class="p">:</span> <span class="n">send_email</span> <span class="p">(</span><span class="n">From</span> <span class="n">user1</span><span class="nv">@example</span><span class="p">.</span><span class="n">com</span><span class="p">)</span>
<span class="n">Sending</span> <span class="n">email</span><span class="p">...</span>
<span class="n">Email</span> <span class="n">sent</span> <span class="n">successfully</span><span class="p">:</span> <span class="n">Subject</span> <span class="s1">&#39;Test Email&#39;</span>

<span class="n">Received</span> <span class="n">task</span><span class="p">:</span> <span class="n">send_email</span> <span class="p">(</span><span class="n">From</span> <span class="n">user2</span><span class="nv">@example</span><span class="p">.</span><span class="n">com</span><span class="p">)</span>
<span class="n">Sending</span> <span class="n">email</span><span class="p">...</span>
<span class="n">Email</span> <span class="n">sent</span> <span class="n">successfully</span><span class="p">:</span> <span class="n">Subject</span> <span class="s1">&#39;Test Email&#39;</span>

<span class="n">Received</span> <span class="n">task</span><span class="p">:</span> <span class="n">send_email</span> <span class="p">(</span><span class="n">From</span> <span class="n">user3</span><span class="nv">@example</span><span class="p">.</span><span class="n">com</span><span class="p">)</span>
<span class="n">Sending</span> <span class="n">email</span><span class="p">...</span>
<span class="n">Email</span> <span class="n">sent</span> <span class="n">successfully</span><span class="p">:</span> <span class="n">Subject</span> <span class="s1">&#39;Test Email&#39;</span>

<span class="n">Received</span> <span class="n">task</span><span class="p">:</span> <span class="n">send_email</span> <span class="p">(</span><span class="n">From</span> <span class="n">user4</span><span class="nv">@example</span><span class="p">.</span><span class="n">com</span><span class="p">)</span>
<span class="n">Sending</span> <span class="n">email</span><span class="p">...</span>
<span class="n">Email</span> <span class="n">sent</span> <span class="n">successfully</span><span class="p">:</span> <span class="n">Subject</span> <span class="s1">&#39;Test Email&#39;</span>
</code></pre></div>

<p>Redis 中 "task_queue" 列表的任务将逐个被消费：</p>
<p><img alt="image.png" src="images/task_queue2.png"></p>
<p>当任务被消费完，Redis会自动删除 "task_queue" 列表。</p>
<blockquote>
<p>Redis 是一个键值（Key-Value）数据库。为了保持高效的内存管理，当一个键所关联的值（比如一个 List、Set 或 Hash）变为空时，<strong>Redis 会自动将这个键从数据库中删除</strong>。</p>
</blockquote>
      </div><!-- /.entry-content -->

    </article>
  </section>
                <section id="extras" class="body">
                                <div class="blogroll">
                                        <h2>links</h2>
                                        <ul>
                                                        <li><a href="https://getpelican.com/">Pelican</a></li>
                                                        <li><a href="https://www.python.org/">Python.org</a></li>
                                                        <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                                                        <li><a href="#">You can modify those links in your config file</a></li>
                                        </ul>
                                </div><!-- /.blogroll -->
                                <div class="social">
                                        <h2>social</h2>
                                        <ul>

                                                        <li><a href="#">You can add links in your config file</a></li>
                                                        <li><a href="#">Another social link</a></li>
                                        </ul>
                                </div><!-- /.social -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

        </body>
</html>